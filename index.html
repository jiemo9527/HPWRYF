<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HPWAYF è§£æ (å¤šçº¿ç¨‹æé€Ÿç‰ˆ)</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: "Segoe UI", Arial, sans-serif; margin: 0; padding: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; background-color: #f8f9fa; }
        .container { width: 90%; max-width: 1000px; background-color: #fff; border-radius: 12px; padding: 25px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); margin-bottom: 20px; max-height: 95vh; overflow-y: auto; }
        h1 { text-align: center; color: #333; margin-bottom: 20px; font-size: 24px; }
        .form-container { text-align: center; margin-bottom: 20px; }
        textarea { width: 100%; padding: 15px; height: 120px; border: 1px solid #ddd; border-radius: 8px; resize: vertical; box-sizing: border-box; font-family: monospace; font-size: 13px; transition: border 0.3s; }
        textarea:focus { border-color: #4CAF50; outline: none; }
        .btn-group { margin-top: 15px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        button { background-color: #4CAF50; color: white; padding: 10px 24px; border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s; font-size: 15px; font-weight: 600; }
        button:hover { background-color: #43a047; transform: translateY(-1px); shadow: 0 2px 5px rgba(0,0,0,0.1); }
        button:disabled { background-color: #b0bec5; cursor: not-allowed; transform: none; }
        button.secondary { background-color: #546e7a; }
        button.secondary:hover { background-color: #455a64; }
        
        .table-container { overflow-x: auto; margin-top: 25px; border-radius: 8px; border: 1px solid #eee; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; white-space: nowrap; }
        th { background-color: #f1f3f5; color: #495057; font-weight: 600; position: sticky; top: 0; }
        tr:hover { background-color: #f8f9fa; }
        
        /* è¿›åº¦æ¡æ ·å¼ */
        .status-bar { margin-top: 15px; background: #f1f1f1; border-radius: 10px; height: 20px; overflow: hidden; position: relative; display: none; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #4CAF50, #81C784); width: 0%; transition: width 0.3s ease; }
        .status-text { position: absolute; width: 100%; text-align: center; top: 0; line-height: 20px; font-size: 12px; color: #333; text-shadow: 0 0 2px white; }
        
        footer { margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; text-align: center; color: #888; font-size: 12px; }
        a { color: #4CAF50; text-decoration: none; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸš€ HPWAYF é“¾æ¥è§£æ (JSå¤šçº¿ç¨‹ç‰ˆ)</h1>
    
    <div class="form-container">
        <textarea id="linksInput" placeholder="è¯·åœ¨æ­¤å¤„ç²˜è´´ VMess / VLESS / SS / Trojan é“¾æ¥ï¼Œæ¯è¡Œä¸€ä¸ª..."></textarea>
        
        <div class="btn-group">
            <button onclick="startProcessing()" id="btnParse">âš¡ å¼€å§‹æé€Ÿè§£æ</button>
            <button onclick="copyToClipboard()" class="secondary">å¤åˆ¶ç»“æœ</button>
            <button onclick="exportResultsToExcel()" class="secondary">å¯¼å‡º Excel</button>
        </div>

        <div id="statusBar" class="status-bar">
            <div id="progressFill" class="progress-fill"></div>
            <div id="statusText" class="status-text">å‡†å¤‡å°±ç»ª</div>
        </div>
    </div>

    <div id="resultArea" style="display:none;">
        <textarea id="linkTextArea" style="height: 80px; margin-bottom: 10px;" placeholder="è§£æåçš„é“¾æ¥å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..." readonly></textarea>
        <div class="table-container">
            <table id="resultsTable">
                <thead>
                    <tr>
                        <th style="width:40px">#</th>
                        <th>Host/IP</th>
                        <th>ç«¯å£</th>
                        <th>å›½å®¶</th>
                        <th>ä»£ç </th>
                        <th>ISP / ç»„ç»‡</th>
                        <th>å¤‡æ³¨ (Remark)</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <footer>
        &copy; 2024 JIEMO | Powered by JavaScript (Client Side)
    </footer>
</div>

<script>
// é…ç½®ï¼šå¹¶å‘æ•°ï¼ˆå»ºè®® 5-10ï¼Œå¤ªé«˜ä¼šè¢«å°ï¼‰
const CONCURRENCY_LIMIT = 5; 
const REMOVE_KEYWORDS = [' INFORMATION TECHNOLOGY (HONGKONG) CO., LIMITED', ' Abr Arvan Co. ( Private Joint Stock)', ' INFORMATION TECHNOLOGY (HK) LIMITED', ' Posts and Telecommunications Group', ' T Broadband Public Company Limited', ' Bilisim Teknolojileri A.S.', ' communications corporation', ' Network Technology Co Ltd', ' (US) Technology Co., Ltd.', ' USA Shared Services Inc.', '(US) Technology Co., Ltd.', ' Communication Co., ltd.', ' (HK) Network Technology', ' Solutions Sdn. Bhd.', ' Digital Global Inc', ' Technologies Inc.', ' International LTD', ' International Ltd', ' Cloud HK Limited', ' Cloud Computing', ' Hosting Sdn Bhd', ' Private Limited', ' Japan Co., Ltd.', ' Communications', ' Cloud Services', ' Data Centers.', ' (HK) Network', ' AFRICA CLOUD', ' Networks Ltd', ' Networks Inc', ' Link Limited', ' EC2 (ap-northeast-1)',' cloud computing (Beijing) Co., Ltd.',' LLC'];

// å·¥å…·å‡½æ•°
const sleep = (ms) => new Promise(r => setTimeout(r, ms));
const safeBase64Decode = (str) => {
    try {
        str = str.replace(/-/g, '+').replace(/_/g, '/');
        while (str.length % 4) str += '=';
        return decodeURIComponent(escape(atob(str)));
    } catch { return ""; }
};

// æ ¸å¿ƒï¼šå¸¦é‡è¯•çš„ IP æŸ¥è¯¢
async function fetchIpInfo(host, retry = 0) {
    // å¦‚æœå·²ç»æ˜¯å¤‡æ³¨è¿‡çš„åŸŸåï¼Œå°è¯•æå–çœŸå®åŸŸåï¼ˆç®€å•åˆ¤æ–­ï¼‰
    const cleanHost = host.split(':')[0]; 

    // ä½¿ç”¨ ipwho.isï¼Œå› ä¸ºå®ƒåœ¨æµè§ˆå™¨ç«¯æ¯”è¾ƒç¨³å®šï¼Œæ”¯æŒ CORS
    const apiUrl = `https://ipwho.is/${cleanHost}?lang=zh-CN`;

    try {
        const res = await fetch(apiUrl);
        // å¦‚æœé‡åˆ° 429 (Too Many Requests)ï¼ŒæŠ›å‡ºé”™è¯¯è¿›å…¥ catch é‡è¯•
        if (res.status === 429) throw new Error("429");
        
        const data = await res.json();
        if (!data.success) return null; // æŸ¥è¯¢å¤±è´¥ï¼ˆå¦‚å†…ç½‘IPï¼‰

        return {
            country: data.country || '',
            code: data.country_code || '',
            city: data.city || '',
            org: data.connection?.org || data.connection?.isp || '',
            isp: data.connection?.isp || ''
        };

    } catch (e) {
        if (retry < 3) {
            // æŒ‡æ•°é€€é¿é‡è¯•ï¼šç¬¬ä¸€æ¬¡ç­‰ 1.5ç§’ï¼Œç¬¬äºŒæ¬¡ç­‰ 3ç§’...
            const waitTime = 1500 * (retry + 1);
            console.warn(`IPæŸ¥è¯¢å—é™ (${host})ï¼Œç­‰å¾… ${waitTime}ms åé‡è¯•...`);
            await sleep(waitTime);
            return fetchIpInfo(host, retry + 1);
        }
        return null;
    }
}

// è§£æå•è¡Œé“¾æ¥
function parseLink(line) {
    line = line.trim();
    if (!line) return null;
    
    let info = { original: line, host: '', port: '', type: '', json: null, valid: false };

    try {
        if (line.startsWith('vmess://')) {
            info.type = 'vmess';
            const json = JSON.parse(safeBase64Decode(line.substring(8)));
            info.json = json;
            info.host = json.add;
            info.port = json.port;
            info.valid = true;
        } else if (line.startsWith('ss://')) {
            info.type = 'ss';
            let body = line.substring(5).split('#')[0];
            // å°è¯•è§£æ SS Base64
            if (!body.includes('@')) {
                try {
                    const decoded = safeBase64Decode(body);
                    const parts = decoded.split(':'); // method:pass@host:port
                    if (decoded.includes('@')) {
                        const atParts = decoded.split('@');
                        const hp = atParts[1].split(':');
                        info.host = hp[0];
                        info.port = hp[1];
                    }
                } catch {}
            } else {
                const atParts = body.split('@');
                const hp = atParts[1].split(':');
                info.host = hp[0];
                info.port = hp[1];
            }
            info.valid = !!info.host;
        } else {
            // VLESS / Trojan ç­‰
            const match = line.match(/^(vless|socks|trojan):\/\/([^@]+)@([^:\/]+)(?::(\d+))?/);
            if (match) {
                info.type = match[1];
                info.host = match[3];
                info.port = match[4] || '';
                info.valid = true;
            }
        }
    } catch (e) {}
    
    return info.valid ? info : null;
}

// ç”Ÿæˆå¤‡æ³¨
function generateRemark(ipData) {
    if (!ipData) return "Unknown";
    let remark = `${ipData.org} - ${ipData.code}`;
    
    // å…³é”®è¯æ›¿æ¢
    remark = remark.replace('Shenzhen Tencent Computer Systems Company Limited', 'Tencent');
    remark = remark.replace('Hangzhou Alibaba Advertising Co', 'Alibaba');
    remark = remark.replace('The Constant Company', 'Constant');
    remark = remark.replace('Google LLC', 'Google');
    
    REMOVE_KEYWORDS.forEach(kw => remark = remark.replace(kw, ''));
    return remark.replace(/^- |- $/g, '').trim() || "Unknown";
}

// å¹¶å‘æ§åˆ¶å™¨
async function asyncPool(poolLimit, array, iteratorFn) {
    const ret = [];
    const executing = [];
    for (const item of array) {
        const p = Promise.resolve().then(() => iteratorFn(item, array));
        ret.push(p);
        
        if (poolLimit <= array.length) {
            const e = p.then(() => executing.splice(executing.indexOf(e), 1));
            executing.push(e);
            if (executing.length >= poolLimit) {
                await Promise.race(executing);
            }
        }
    }
    return Promise.all(ret);
}

// ä¸»é€»è¾‘
async function startProcessing() {
    const input = document.getElementById('linksInput').value;
    if (!input.trim()) { alert('è¯·å…ˆç²˜è´´é“¾æ¥ï¼'); return; }

    // UI åˆå§‹åŒ–
    const btn = document.getElementById('btnParse');
    const tableBody = document.getElementById('tableBody');
    const linkTextArea = document.getElementById('linkTextArea');
    const statusBar = document.getElementById('statusBar');
    const progressFill = document.getElementById('progressFill');
    const statusText = document.getElementById('statusText');
    
    btn.disabled = true;
    document.getElementById('resultArea').style.display = 'block';
    statusBar.style.display = 'block';
    tableBody.innerHTML = '';
    linkTextArea.value = '';
    
    const lines = input.split('\n');
    const tasks = lines.map(line => parseLink(line)).filter(i => i);
    
    let finishedCount = 0;
    const totalCount = tasks.length;
    let resultsText = [];
    let resultsRows = []; // æš‚å­˜è¡Œæ•°æ®ä»¥ä¾¿æ’åºï¼ˆå¯é€‰ï¼‰

    // å®šä¹‰å•ä¸ªä»»åŠ¡çš„å¤„ç†é€»è¾‘
    const processItem = async (item) => {
        // 1. æŸ¥è¯¢ IP
        const ipData = await fetchIpInfo(item.host);
        
        // 2. ç”Ÿæˆå¤‡æ³¨
        const remark = generateRemark(ipData);
        
        // 3. é‡ç»„é“¾æ¥
        let newLink = "";
        if (item.type === 'vmess') {
            item.json.ps = remark;
            newLink = "vmess://" + btoa(JSON.stringify(item.json));
        } else {
            const base = item.original.split('#')[0];
            newLink = `${base}#${encodeURIComponent(remark)}`;
        }

        // 4. æ›´æ–° UI (è¿›åº¦æ¡)
        finishedCount++;
        const percent = Math.round((finishedCount / totalCount) * 100);
        progressFill.style.width = `${percent}%`;
        statusText.innerText = `æ­£åœ¨å¤„ç†: ${finishedCount} / ${totalCount} (${item.host})`;

        // 5. å®æ—¶æ·»åŠ åˆ°è¡¨æ ¼å’Œæ–‡æœ¬æ¡†ï¼ˆä¿æŒå“åº”æ„Ÿï¼‰
        // æ³¨æ„ï¼šå› ä¸ºå¹¶å‘ï¼Œè¡¨æ ¼é¡ºåºå¯èƒ½ä¼šä¹±ï¼Œè¿™é‡Œç›´æ¥æŒ‰å®Œæˆé¡ºåºæ·»åŠ 
        // å¦‚æœéœ€è¦ä¸¥æ ¼é¡ºåºï¼Œå¯ä»¥æœ€åå†ç»Ÿä¸€æ¸²æŸ“ï¼Œä½†ç”¨æˆ·ä½“éªŒä¼šè§‰å¾—æ…¢
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${finishedCount}</td>
            <td>${item.host}</td>
            <td>${item.port}</td>
            <td>${ipData ? ipData.country : '-'}</td>
            <td>${ipData ? ipData.code : '-'}</td>
            <td>${ipData ? ipData.org : '-'}</td>
            <td><b>${remark}</b></td>
        `;
        tableBody.appendChild(tr);
        
        // æš‚å­˜é“¾æ¥ç»“æœ
        return newLink;
    };

    // å¼€å§‹å¹¶å‘æ‰§è¡Œ
    const finalLinks = await asyncPool(CONCURRENCY_LIMIT, tasks, processItem);
    
    // å®Œæˆ
    linkTextArea.value = finalLinks.join('\n');
    statusText.innerText = "âœ… å…¨éƒ¨å®Œæˆï¼";
    btn.disabled = false;
}

// å¤åˆ¶åŠŸèƒ½
function copyToClipboard() {
    const textarea = document.getElementById('linkTextArea');
    if(!textarea.value) return;
    textarea.select();
    document.execCommand('copy');
    alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
}

// Excel å¯¼å‡º
function exportResultsToExcel() {
    const table = document.getElementById('resultsTable');
    if (table.rows.length <= 1) return;
    const wb = XLSX.utils.table_to_book(table, {sheet: "Result"});
    XLSX.writeFile(wb, `Parsed_Links_${new Date().toISOString().slice(0,10)}.xlsx`);
}
</script>
</body>
</html>